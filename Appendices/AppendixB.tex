\chapter{LED контроллер AT89C51ED2} % Main appendix title

\label{AppendixB} % For referencing this appendix elsewhere, use \ref{AppendixA}
\pagecolor{white}

%        ---------------Програмын кодыг бичсэн жишээ 
\begin{lstlisting}
  ;   2020-12-13  last ver
;----------------------------------------------------------   595 shift
PDAT         	EQU       P0      ;shift data
r_A		EQU	   P10
r_B		EQU	   P11
OE          	EQU        P12	  ;down 595 enable                                                               
SRCLK		EQU	  P35     ;595 latch serial data shift clock          CLK
RCLK		EQU	  P36     ;595 latch parallel data output clock       SCLK
PL_1		EQU	  P37	  ;select 1st reg    

COIL_RLY        EQU       P13     ;        
;----------------------------------------------------------
RxD_OK           equ      01h   ;
;==========================================================
Buff_6               EQU    30h                
Buff_5               EQU    31h 
Buff_4               EQU    32h
Buff_3               EQU    33h                
Buff_2               EQU    34h 
Buff_1               EQU    35h
;----------
Buff_01              EQU    36h 
Buff_00              EQU    37h
;----------------------------------  
Numb_6             EQU     38h    ; High
Numb_5             EQU     39h
Numb_4             EQU     3Ah
Numb_3             EQU     3Bh
Numb_2             EQU     3Ch
Numb_1             EQU     3Dh    ;Low
;------------
Numb_01             EQU    3Eh
Numb_00             EQU    3Fh    ; 

time_sec            EQU    40h
;-------------------------  ADR_DISPLAY RAM --------------
Disp_6             EQU     09h    ; High
Disp_5             EQU     08h
Disp_4             EQU     07h
Disp_3             EQU     06h
Disp_2             EQU     05h
Disp_1             EQU     04h    ;Low
;-------------
Disp_01            EQU     03h
Disp_00            EQU     02h    ;  
;----------------------------------------- 
Beg_adr       EQU    0002h       ;0000h      ; begin RAM adr shif

;****************************************************************
org 0000
ljmp START                  
org 0003h                             
reti        
org 000bh                                        ;TF0  clock
reti        ;ljmp CLOCK               
org 0013h
reti
org 001bh
reti	
org 0023h
ljmp SER_PORT               ; RI+TI serial intrupt from PC
;****************************************************************
START:            mov sp,#0c8h                    ;200 
mov scon,#01010100b  ; mode1,variable speed
mov tl1,#0fDh        ; (BAUDRATE=9600 IF OSC = 22.1184MHz)
mov th1,#0fDh	  ;	RELOAD BAUDRATE VALUE
;--TH1=0F7H (BAUDRATE=9600 IF OSC = 33.1776MHz)
;--TH1=0FAH (BAUDRATE=14400 IF OSC = 33.1776MHz Timer1 mode2 SMOD=0)

mov AUXR,#00010000b
mov AUXR1,#0000000b

mov tmod,#00100001b ; GA1=0, c/T1=0, mode1=10,     GA0=0,c/T0=1,  mode0=01
mov tcon,#01000000b ; TF1=0,  TR1=1, TF0=0, TR0=0, IE1=0, IT1=0, IE0=0, IT0=0 
mov IE,#00010010b  ; EA= 0, -=0,  ET2=0, ES= 1, ET1=0, EX1=0, ET0=1, EX0=0
clr  TR0
setb EA
;--------------------------------------------  default  
MOV PDAT,#0
clr r_A
clr r_B
clr OE                      ;setb OE
clr RCLK
clr SRCLK
setb PL_1
clr COIL_RLY 
;---------------------------------------------------------------         
mov dptr,#0000h                     ; Clear Disp RAM
mov a,#00h 
mov r2,#160                             
clr1:   movx @dptr,a
inc dptr
djnz r2,clr1 
;-----------------------------
clr RxD_OK 
mov time_sec,#00h

mov Numb_6,#20h        ; High   Disp_6 
mov Numb_5,#20h        ;        Disp_5
mov Numb_4,#20h        ;        Disp_4
mov Numb_3,#20h        ;        Disp_3
mov Numb_2,#20h        ;        Disp_2
mov Numb_1,#20h        ; Low    Disp_1

mov Numb_01,#20h       ; 
mov Numb_00,#2eh      ; $
;----------------------------- Copy Disp RAM ------------------
mov r6,#Disp_6      ; High    
mov a,Numb_6
Lcall chr_beg
mov r6,#Disp_5
mov a,Numb_5
Lcall chr_beg
mov r6,#Disp_4
mov a,Numb_4
Lcall chr_beg
mov r6,#Disp_3
mov a,Numb_3
Lcall chr_beg
mov r6,#Disp_2
mov a,Numb_2
Lcall chr_beg
mov r6,#Disp_1       ; Low
mov a,Numb_1
Lcall chr_beg
;----------------
mov r6,#Disp_01
mov a,Numb_01
Lcall chr_beg
mov r6,#Disp_00       
mov a,Numb_00
Lcall chr_beg
;***************************************************************** 
MAIN_00:  jbc RxD_OK,New_dat 
mn_01:  lcall REFRESH  
sjmp MAIN_00

New_dat: mov Numb_6,Buff_6 
mov Numb_5,Buff_5 
mov Numb_4,Buff_4 
mov Numb_3,Buff_3 
mov Numb_2,Buff_2
mov Numb_1,Buff_1  
;-----------------
mov Numb_01,Buff_01
mov Numb_00,Buff_00  

;----------------------------- Copy Disp RAM ------------------
mov r6,#Disp_6      ; High    
mov a,Numb_6
Lcall chr_beg
mov r6,#Disp_5
mov a,Numb_5
Lcall chr_beg
mov r6,#Disp_4
mov a,Numb_4
Lcall chr_beg
mov r6,#Disp_3
mov a,Numb_3
Lcall chr_beg
mov r6,#Disp_2
mov a,Numb_2
Lcall chr_beg
mov r6,#Disp_1       ; Low
mov a,Numb_1
Lcall chr_beg
;----------------
mov r6,#Disp_01
mov a,Numb_01
Lcall chr_beg
mov r6,#Disp_00       
mov a,Numb_00
Lcall chr_beg

Lcall CHECK_RELAY
Ljmp mn_01 
;================================================================
;                                SUB CALL  
;================================================================ 
chr_beg:          mov b,#83                    ;0c0h
mul ab
mov dpl,a
mov a,b
orl a,#80h
mov dph,a              ;adr dptr=  begin code 
inc dptr
;---------------------------------------------------------------
INC AUXR1
mov dpl,r6
mov dph,#00h
INC AUXR1                                ; (optional) restore DPS  
;----------------------- to RAM  shift ASCII code  2byte x 16 row  
mov b,#16                        ;num_row  ; row=16
asc_0:       mov a,#00h
movc a,@a+dptr
inc dptr
inc dptr
;------
INC AUXR1                        ;   switch data pointers
movx @dptr,a                     ; adr_beg 0002h RAM
clr c  
mov a,dpl
addc a,#10                       ;offset_shift =10-1=9
mov dpl,a
mov a,dph
addc a,#0
mov dph,a
INC AUXR1                        ; (optional) restore DPS  
;---------
djnz b,asc_0
ret
;--------------------------------------------------------------
clear_disp:    mov dptr,#0000h                  ;#Beg_adr                            
mov r2,#160
mov a,#00h            
rep_mem1:   movx @dptr,a
inc dptr
djnz r1,rep_mem1
ret


\end{lstlisting}